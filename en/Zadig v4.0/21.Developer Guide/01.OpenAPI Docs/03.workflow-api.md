---
title: Workflow
date: 2021-03-19 09:32:04
permalink: /en/Zadig v4.0/api/workflow/
---

This article mainly introduces how to use OpenAPI to operate Zadig's workflow.

## Workflow

### Get a Workflow List

**Request**

```
GET /openapi/workflows?projectKey=<project identifier>&viewName=<view name>
```

**Query**

| Parameter Name | Required | Description        | Is it Required | Default Value |
| -------------- | -------- | ------------------ | -------------- | ------------- |
| `projectKey`   | string   | Project identifier | Yes            | None          |
| `viewName`     | string   | Workflow view name | No             | None          |

**Return Description**

| Parameter Name | Required                  | Description   |
| -------------- | ------------------------- | ------------- |
| `workflows`    | [][workflow](#workflow-5) | Workflow list |

<h4 id="workflow-5">workflow</h4>

| Parameter Name  | Required | Description         |
| --------------- | -------- | ------------------- |
| `workflow_key`  | string   | Workflow Identifier |
| `workflow_name` | string   | Workflow Name       |
| `update_by`     | string   | Updater             |
| `update_time`   | int      | Update Time         |
| `type`          | string   | `custom`            |

**Return successfully**

::: details

```json
{
    "workflows": [
        {
            "workflow_key": "just-deploy",
            "workflow_name": "just-deploy",
            "update_by": "admin",
            "update_time": 1686217885,
            "type": "custom"
        },
        {
            "workflow_key": "xiaxianfuwu",
            "workflow_name": "offline service",
            "update_by": "admin",
            "update_time": 1686193453,
            "type": "custom"
        }
    ]
}
```

:::

### Get Workflow Details

**Request**

```
GET /openapi/workflows/custom/:workflowKey/detail?projectKey=<project identifier>
```

**Query**

| Parameter Name | Required | Description        | Is it Required | Default Value |
| -------------- | -------- | ------------------ | -------------- | ------------- |
| `projectKey`   | string   | Project identifier | Yes            | None          |

**Path parameter description**

| Parameter Name | Required | Description         | Is it Required | Default Value |
| -------------- | -------- | ------------------- | -------------- | ------------- |
| `workflowKey`  | string   | Workflow Identifier | Yes            | None          |

**Return successfully**

::: details

```json
{
    "workflow_key": "build-deploy", // workflow identifier
    "workflow_name": "build-deploy", // workflow name
    "project_key": "lilian-test", // project identifier
    "description": "", // workflow description
    "created_by": "admin", // creator
    "create_time": 1686192946, // creation time
    "updated_by": "", // updater
    "update_time": 1690180684, // update time
    "params": [ // workflow parameter list
        {
            "name": "code",
            "description": "",
            "type": "repo",
            "value": "",
            "repo": {
                "source": "gitee",
                "repo_owner": "liyue326",
                "repo_namespace": "liyue326",
                "repo_name": "picture",
                "remote_name": "origin",
                "branch": "master",
                "hidden": false,
                "is_primary": false,
                "codehost_id": 4,
                "oauth_token": "",
                "address": "",
                "source_from": "",
                "param_name": "",
                "job_name": "",
                "service_name": "",
                "service_module": "",
                "repo_index": 0,
                "submission_id": ""
            },
            "default": "",
            "is_credential": false
        },
        {
            "name": "name",
            "description": "",
            "type": "string",
            "value": "build",
            "repo": null,
            "default": "",
            "is_credential": false
        }
    ],
    "stages": [ // workflow stage list
        {
            "name": "build", // stage name
            "parallel": true, // whether to run concurrently
            "approval": { // approval information
                "enabled": false,
                "type": "native",
                "description": "",
                "native_approval": {
                    "Timeout": 5,
                    "approve_users": [],
                    "NeededApprovers": 0
                },
                "dingtalk_approval": {
                    "Timeout": 5
                }
            },
            "jobs": [ // workflow job list
                {
                    "name": "build", // job name
                    "type": "zadig-build", // job type
                    "skipped": false, // skipped
                    "spec": { // job detail
                        "docker_registry_id": "630c7ad700430c131062e245",
                        "service_and_builds": [
                            {
                                "build_name": "openapi-build",
                                "image": "",
                                "image_name": "service1",
                                "key_vals": [],
                                "repos": [],
                                "service_module": "service1",
                                "service_name": "service1",
                                "share_storage_info": null
                            }
                        ]
                    },
                    "run_policy": "",
                    "service_modules": []
                }
            ]
        },
        {
            "name": "deploy",
            "parallel": true,
            "approval": {
                "enabled": false,
                "type": "native",
                "description": "",
                "native_approval": {
                    "Timeout": 5,
                    "approve_users": [],
                    "NeededApprovers": 0
                },
                "dingtalk_approval": {
                    "Timeout": 5
                }
            },
            "jobs": [
                {
                    "name": "deploy",
                    "type": "zadig-deploy",
                    "skipped": false,
                    "spec": {
                        "deploy_contents": [
                            "image",
                            "vars"
                        ],
                        "deploy_type": "",
                        "env": "dev",
                        "job_name": "build",
                        "origin_job_name": "",
                        "production": false,
                        "service_and_images": [],
                        "services": [
                            {
                                "key_vals": [],
                                "latest_key_vals": [],
                                "latest_variable_kvs": [],
                                "service_name": "service2",
                                "updatable": false,
                                "update_config": false,
                                "variable_configs": [],
                                "variable_kvs": [],
                                "variable_yaml": ""
                            },
                            {
                                "key_vals": [],
                                "latest_key_vals": [],
                                "latest_variable_kvs": [],
                                "service_name": "service1",
                                "updatable": true,
                                "update_config": false,
                                "variable_configs": [
                                    {
                                        "use_global_variable": false,
                                        "variable_key": "cpuLimit"
                                    },
                                    {
                                        "use_global_variable": false,
                                        "variable_key": "memoryLimit"
                                    },
                                    {
                                        "use_global_variable": false,
                                        "variable_key": "port"
                                    }
                                ],
                                "variable_kvs": [],
                                "variable_yaml": ""
                            }
                        ],
                        "skip_check_run_status": false,
                        "source": "fromjob"
                    },
                    "run_policy": "",
                    "service_modules": []
                },
                {
                    "name": "default",
                    "type": "plugin",
                    "skipped": false,
                    "spec": {
                        "plugin": {
                            "args": [
                                "echo $(inputs.CONTENT)"
                            ],
                            "category": "",
                            "cmds": [
                                "/bin/sh",
                                "-c"
                            ],
                            "description": "hello world",
                            "envs": [
                                {
                                    "name": "CONTENT",
                                    "value": "$(inputs.CONTENT)"
                                }
                            ],
                            "image": "alpine/curl:3.14",
                            "inputs": [
                                {
                                    "default": "hello world",
                                    "description": "content to print",
                                    "is_credential": false,
                                    "name": "CONTENT",
                                    "repo": null,
                                    "type": "string",
                                    "value": "hello world"
                                }
                            ],
                            "is_offical": false,
                            "name": "hello-world",
                            "outputs": [],
                            "repo_url": "",
                            "version": "v0.0.1"
                        },
                        "properties": {
                            "build_os": "",
                            "cache": {
                                "medium_type": "",
                                "nfs_properties": {
                                    "provision_type": "",
                                    "pvc": "",
                                    "storage_class": "",
                                    "storage_size_in_gib": 0,
                                    "subpath": ""
                                },
                                "object_properties": {
                                    "id": ""
                                }
                            },
                            "cache_dir_type": "",
                            "cache_enable": false,
                            "cache_user_dir": "",
                            "cluster_id": "",
                            "custom_envs": [],
                            "envs": [],
                            "image_from": "",
                            "image_id": "",
                            "log_file_name": "",
                            "namespace": "",
                            "params": [],
                            "registries": [],
                            "res_req": "low",
                            "res_req_spec": {
                                "cpu_limit": 1000,
                                "gpu_limit": "",
                                "memory_limit": 512
                            },
                            "retry": 0,
                            "share_storage_details": [],
                            "timeout": 60
                        }
                    },
                    "run_policy": "",
                    "service_modules": []
                }
            ]
        }
    ],
    "notify_ctls": [ // Notification Configuration List
        {
            "enabled": true,
            "webhook_type": "wechat",
            "weChat_webHook": "xxx",
            "notify_type": [
                "created",
                "failed"
            ]
        }
    ],
    "share_storages": [], // Shared Volume
    "concurrency_limit": 1 // Concurrent Execution Quantity
}
```

:::

### Get a Workflow Task List

**Request**

```
GET /openapi/workflows/custom/:workflowKey/tasks?projectKey=<project identifier>
```

**query Parameter description**

| Parameter Name | Required | Description                            | Is it Required | Default Value |
| -------------- | -------- | -------------------------------------- | -------------- | ------------- |
| `projectKey`   | string   | Project identifier                     | Yes            | None          |
| `pageNum`      | int      | Pagination - Current page count        | No             | 1             |
| `pageSize`     | int      | Pagination - Single page display entry | No             | 50            |

**Path parameter description**

| Parameter Name | Required | Description         | Is it Required | Default Value |
| -------------- | -------- | ------------------- | -------------- | ------------- |
| `workflowKey`  | string   | Workflow Identifier | Yes            | None          |

**Return Description**

| Parameter Name   | Required                            | Description          |
| ---------------- | ----------------------------------- | -------------------- |
| `total`          | int                                 | Total workflow tasks |
| `workflow_tasks` | [][workflow_task](#workflow_task-1) | Workflow task list   |

<h4 id="workflow_task-1">workflow_task</h4>

| Parameter Name  | Required | Description                                                                                                                         |
| --------------- | -------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| `workflow_key`  | string   | Workflow Identifier                                                                                                                 |
| `workflow_name` | string   | Workflow Name                                                                                                                       |
| `project_key`   | string   | Project identifier                                                                                                                  |
| `task_id`       | int      | Workflow task ID                                                                                                                    |
| `task_creator`  | string   | Workflow Task Executor                                                                                                              |
| `create_time`   | int      | Workflow task creation time                                                                                                         |
| `start_time`    | int      | Workflow task start time                                                                                                            |
| `end_time`      | int      | Workflow task end time                                                                                                              |
| `status`        | string   | Task status includes: created (created), running (running), passed (passed), failed (failed), timeout (timeout), cancelled (cancel) |

**Return normally**



```json
{
    "total": 15,
    "workflow_tasks": [
        {
            "workflow_key": "build-deploy",
            "workflow_name": "build-deploy",
            "project_key": "lilian-test",
            "task_id": 15,
            "create_time": 1688543613,
            "task_creator": "webhook",
            "start_time": 1688543615,
            "end_time": 1688543636,
            "status": "passed"
        }
    ]
}
```

**Exception return**

```json
{
    "code": 400,
    "description": "workflow name is required",
    "extra": {},
    "message": "Bad Request",
    "type": "error"
}
```



### Get Workflow Task Details

```
GET /openapi/workflows/custom/task?taskId=<workflow task ID>&workflowKey=<workflow identifier>
```

**Query**

| Parameter Name | Required | Description         | Default Value | Is it Required |
| -------------- | -------- | ------------------- | ------------- | -------------- |
| `taskId`       | int      | Workflow Task ID    | None          | Yes            |
| `workflowKey`  | string   | Workflow Identifier | None          | Yes            |

**Return normally**

::: details
```
{
    "task_id": 24,                              # Workflow task ID
    "workflow_key": "build-images",            # Workflow identifier
    "params": [                                 # Workflow variables
        {
            "name": "USERNAME",
            "description": "",
            "type": "string",
            "value": "zadig",
            "default": "",
            "is_credential": false
        }
    ],
    "status": "running",                        # Workflow task status
    "task_creator": "admin",                    # Workflow task trigger
    "create_time": 1664161285,                  # Workflow task creation time, Unix timestamp format
    "start_time": 1664161286,                   # Workflow task start execution time, Unix timestamp format
    "end_time": 1664172997,                     # Workflow task execution end time, Unix timestamp format
    "stages": [                                 # Workflow task includes all stage details
        {
            "name": "build",                      # Stage name
            "status": "passed",                 # Stage status
            "start_time": 1664161286,           # Stage execution start time, Unix timestamp format
            "end_time": 1664172974,             # Stage execution end time, Unix timestamp format
            "jobs": [                           # Stage includes all task details
                {
                    "name": "a-myapp-1-build-myapps",
                    "type": "zadig-build",      # Built-in build task
                    "status": "passed",         # Task status
                    "start_time": 1664172967,   # Task execution start time, Unix timestamp format
                    "end_time": 1664172974,     # Task execution end time, Unix timestamp format
                    "spec": {                   # Build task execution detailed information (including code information, image information, service information, service component information, build variable information)
                        "repos": [              # Code information
                            {
                                "source": "gitee",
                                "repo_owner": "kr-test-dev",
                                "repo_namespace": "kr-test-dev",
                                "repo_name": "zadig",
                                "remote_name": "origin",
                                "branch": "main",
                                "commit_id": "a13120997b95d8b63f2b5b29c700f89d38a5de54",
                                "commit_message": "update pkg/microservice/warpdrive/config/const.go.\n\nSigned-off-by: grandy <10196377+grandy@user.noreply.gitee.com>",
                                "address": "https://gitee.com",
                                "author_name": "grandy"
                            }
                        ],
                        "image": "koderover.tencentcloudcr.com/koderover-demo/myapp-1:20220926141606-26-main", # Image information
                        "service_name": "a",            # Service name
                        "service_module": "myapp-1",    # Service component name
                        "envs": [                       # Build variable information
                            {
                                "key": "username",
                                "value": "admin",
                                "type": "string",
                                "is_credential": false
                            },
                            {
                                "key": "password",
                                "value": "zadig",
                                "type": "string",
                                "is_credential": true
                            },
                            {
                                "key": "version",
                                "value": "1",
                                "type": "string",
                                "is_credential": false
                            }
                        ]
                    }
                }
            ]
        },
        {
            "name": "Deploy",
            "status": "passed",
            "start_time": 1664172974,
            "end_time": 1664172990,
            "approval": {                               # Approval information
                "enabled": true,                        # Need approval
                "approve_users": [                      # Approval user list
                    {
                        "user_name": "admin",
                        "reject_or_approve": "approve",
                        "comment": "LGTM",
                        "operation_time": 1664172985
                    }
                ],
                "timeout": 120,                         # Approval timeout, unit: minute
                "needed_approvers": 1,                  # Number of approvals required
                "description": "Need approval to deploy",       # Approval description
                "reject_or_approve": "approve"          # approve: pass; reject: reject
            },
            "jobs": [
                {
                    "name": "a-myapp-1-deploy-myapps",
                    "type": "zadig-deploy",             # Built-in deployment task
                    "status": "passed",
                    "start_time": 1664172986,
                    "end_time": 1664172990,
                    "spec": {                           # Deployment task detailed information
                        "env": "dev",
                        "skip_check_run_status": false, # Whether to close service status detection
                        "service_and_images": [         # Deployment service, service component, image information
                            {
                                "service_name": "a",
                                "service_module": "myapp-1",
                                "image": "koderover.tencentcloudcr.com/koderover-demo/myapp-1:20220926141606-26-main"
                            }
                        ]
                    }
                }
            ]
        },
        {
            "name": "General task",
            "status": "passed",
            "start_time": 1664172990,
            "end_time": 1664172993,
            "jobs": [
                {
                    "name": "echo-hello",
                    "type": "freestyle",                # General task
                    "status": "passed",
                    "start_time": 1664172990,
                    "end_time": 1664172993,
                    "spec": {                           # General task execution detailed information
                        "repos": [
                            {
                                "source": "gitee",
                                "repo_owner": "kr-test-dev",
                                "repo_namespace": "kr-test-dev",
                                "repo_name": "demo-test",
                                "remote_name": "origin",
                                "branch": "master",
                                "commit_id": "2000aba9195bfce73b0a676e48c0ebfe2f59a4a9",
                                "commit_message": "update org-debug.txt.\n\nSigned-off-by: grandy <10196377+grandy@user.noreply.gitee.com>",
                                "address": "https://gitee.com",
                                "author_name": "grandy"
                            }
                        ],
                        "image": "",
                        "service_name": "",
                        "service_module": "",
                        "envs": [
                            {
                                "key": "myName",
                                "value": "zadig",
                                "type": "string",
                                "is_credential": false
                            }
                        ]
                    }
                }
            ]
        },
        {
            "name": "Custom task",
            "status": "passed",
            "start_time": 1664172993,
            "end_time": 1664172997,
            "jobs": [
                {
                    "name": "say-hi",
                    "type": "plugin",                   # Custom
                    "status": "passed",
                    "start_time": 1664172993,
                    "end_time": 1664172997,
                    "error": "",
                    "spec": {
                        "name": "Output Hello greeting information",
                        "is_offical": false,
                        "description": "Greet specified user",
                        "repo_url": "",
                        "version": "v0.0.1",
                        "image": "koderover.tencentcloudcr.com/koderover-public/greeting-bot:20220923-amd64",
                        "args": [],
                        "cmds": [],
                        "envs": [
                            {
                                "name": "WHO_AM_I",
                                "value": "Zadig"
                            },
                            {
                                "name": "WEATHER_STATUS",
                                "value": "sunny"
                            }
                        ],
                        "inputs": [
                            {
                                "name": "who_am_i",
                                "description": "who am i",
                                "type": "string",
                                "value": "zadig",
                                "default": "zadig",
                                "is_credential": false
                            },
                            {
                                "name": "weather_status",
                                "description": "what's the weather like today",
                                "type": "choice",
                                "value": "sunny",
                                "choice_否": [
                                    "sunny",
                                    "cloudy",
                                    "rainy"
                                ],
                                "default": "sunny",
                                "is_credential": false
                            }
                        ],
                        "outputs": []
                    }
                }
            ]
        }
    ],
    "project_key": "simple-service-demo",              # Project identifier
}
```
:::

**Exception return**

```
# The specified workflow task does not exist
{
    "code": 500,
    "description": "mongo: no documents in result",
    "message": "Internal Error: "
}
```

### Execute the Workflow

**Request**

```
POST /openapi/workflows/custom/task
```

**Tapd Task**
```
{
    "job_name": "tapd",                                 # Tapd task name
    "job_type": "tapd",                                 # Tapd task type, specify tapd
    "parameters": {
        "project_id": "43976133",                       # Tapd project id
        "project_name": "Welcome to TAPD DEMO",         # Tapd project name
        "status": "open",                               # Optional values: done, open, or custom values
        "iterations": [
            {
                "iteration_id": "1143976133001000001",  # Tapd iteration id
                "iteration_name": "Current iteration",   # Tapd iteration name
                "start_date": "2025-08-04",             # Tapd iteration start time
                "end_date": "2025-09-03"                # Tapd iteration end time
            }
        ]
    }
}
```

**body Parameter sample**

::: details
```
{
    "project_key": "helm", // Project identifier
    "workflow_key": "test-openapi", // Workflow identifier
    "parameters": [ // Global variables
        {
            "name": "test",
            "type": "string",
            "value": "zadig"
        },
        {
            "name": "abc",
            "type": "choice",
            "value": "123"
        },
        {
            "name": "repo1",
            "type: "repo",
            "repo": {
                "codehost_name": "gitlab",
                "repo_namespace": "kr-poc",
                "repo_name": "num_test",
                "branch": "master",
                "prs": [
                    1
                ]
            }
        }
    ],
    "inputs": [
        {
            "job_name": "build-myapps",
            "job_type": "zadig-build",
            "parameters": {
                "registry": "https://koderover.******.com/test",
                "service_list": [
                    {
                        "service_module": "aslan",
                        "service_name": "zadig",
                        "repo_info": [{
                            "codehost_name": "koderover",
                            "repo_namespace": "koderover",
                            "repo_name": "zadig",
                            "branch": "main"
                        }]
                        inputs: [{
                            "key": "username",
                            "value": "admin"
                        },
                        {
                            "key": "password",
                            "value": "Zadig"
                        }]
                    }
                ]
            }
        },
        {
            "job_name": "deploy-myapps",
            "job_type": "zadig-deploy",
            "parameters": {
                "env_name": "dev",
                "service_list": [
                {
                    "service_name": "zadig",
                    "service_module": "aslan",
                    "image_name": "koderover.******.com/test/aslan:main",
                    "value_merge_strategy": "override"
                },
                {
                    "service_name": "zadig",
                    "service_module": "zadig-portal",
                    "image_name": "koderover.******.com/test/zadig-portal:main",
                    "value_merge_strategy": "reuse-values"
                }
                ]
            }
        },
        {
            "job_name": "jira-issue-update",
            "job_type": "freestyle",
            "parameters": {
                "kv": [
                    {
                        "key": "IssueID",
                        "value": "ZAD-10126"
                    },
                    {
                        "key": "FromStatus",
                        "value": "Testing"
                    },
                    {
                        "key": "TargetStatus",
                        "value": "ToBeReleased"
                    }
                ]
            }
        },
        {
            "job_name": "deploy-my-app",
            "job_type": "custom-deploy",
            "parameters": {
                "target_list": [
                    {
                        "workload_type": "Deployment",
                        "workload_name": "service2",
                        "container_name": "service2",
                        "image_name": "koderover.***.com/test/service2:0505"
                    }
                ]
            }
        },
        {
            "job_name": "sql",
            "job_type": "sql",
            "parameters": {
                "database_name": "mysql",
                "sql": "show databases;"
            }
        }
    ]
}
```
:::

**body Parameter description**

| Parameter Name | Required                  | Description                                    | Default Value | Is it Required |
| -------------- | ------------------------- | ---------------------------------------------- | ------------- | -------------- |
| `project_key`  | string                    | Project identifier                             | None          | Yes            |
| `workflow_key` | string                    | Workflow Identifier                            | None          | Yes            |
| `parameters`   | [][Parameter](#parameter) | Global Variables                               | None          | No             |
| `inputs`       | [][Input](#input_arg)     | Specific parameters for the execution workflow | None          | Yes            |

<h4 id="parameter">Parameter</h4>

| Parameter Name | Required      | Description                                                            | Default Value | Is it Required |
| -------------- | ------------- | ---------------------------------------------------------------------- | ------------- | -------------- |
| `name`         | string        | Variable Name                                                          | None          | Yes            |
| `type`         | string        | Type, support string/text/choice/repo                                  | None          | Yes            |
| `value`        | string        | Variable value, which is used when type string/text/choice             | None          | Yes            |
| `repo`         | [Repo](#repo) | The variable value of type repo, which field is used only if type repo | None          | No             |

<h4 id="repo">Repo</h4>

| Parameter Name   | Required | Description                | Default Value | Is it Required |
| ---------------- | -------- | -------------------------- | ------------- | -------------- |
| `codehost_name`  | string   | Code source identification | None          | Yes            |
| `repo_namespace` | string   | namespace of repo          | None          | Yes            |
| `repo_name`      | string   | The name of the repo       | None          | Yes            |
| `branch`         | string   | Branch name                | None          | Yes            |
| `prs`            | []int    | pr number                  | None          | No             |


<h4 id="!">Input Parameter description</h4>

The following will introduce the trigger parameters of built-in build tasks, deployment tasks, Kubernetes deployment tasks, and general tasks separately.

**Build tasks**

```
{
    "job_name": "build-myapps",                           # Build task name
    "job_type": "zadig-build",                            # Build task type, specified as zadig-build
    "parameters": {
        "registry": "https://koderover.******.com/test",  # Image repository information
        "service_list": [                                 # Service information to be built
            {
                "service_module": "aslan",                # Service component name
                "service_name": "zadig",                  # Service name
                "repo_info": [{                           # Code repository information for building the service component
                    "codehost_name": "koderover",         # Code source identifier
                    "repo_namespace": "koderover",        # Code repository organization name/username
                    "repo_name": "zadig",                 # Code repository name
                    "branch": "main",                     # Code repository branch
                    "enable_commit": true,                # Whether to enable the use of commit id to build
                    "commit_id": "e1f10409e99c3f13b0777d2cd8b1a42750b093e1"    # The commit id used to build, only takes effect when enable_commit is true
                }]
                inputs: [{                                # Build variable information, if set to a fixed value or global variable, no need to specify
                    "key": "username",
                    "value": "admin"
                },
                {
                    "key": "password",
                    "value": "Zadig"
                }]
            },
            {
                "service_module": "zadig-portal",
                "service_name": "zadig",
                "repo_info": [{
                    "codehost_name": "koderover",
                    "repo_namespace": "koderover",
                    "repo_name": "zadig-portal",
                    "branch": "main"
                }]
            }
        ]
    }
}
```

**Deploy tasks**

```
{
    "job_name": "deploy-myapps",                              # Deployment task name
    "job_type": "zadig-deploy",                               # Deployment task type, specified as zadig-deploy
    "parameters": {                                           # Deployment parameters
        "env_name": "dev",                                    # Deployment environment information, if set to a fixed value or global variable, no need to configure this field
        "service_list": [                                     # Deployment service information, if set to other task output, no need to configure this field
        {
            "service_name": "zadig",                           # Deployment service name
            "service_module": "aslan",                         # Deployment service component name
            "image_name": "koderover.***.com/test/aslan:main", # Deployment service component image
            "value_merge_strategy": "reuse-values"             # Deployment service values merge strategy (for helm chart service only). The values can be reuse-values or override
        },
        {
            "service_name": "zadig",
            "service_module": "zadig-portal",
            "image_name": "koderover.***.com/test/zadig-portal:main",
            "value_merge_strategy": "override"
        }
    ]
}
```

**Kubernetes Deploy tasks**

```
{
    "job_name": "deploy-my-app",                                     # Kubernetes deployment task name
    "job_type": "custom-deploy",                                     # Kubernetes deployment task type, specified as custom-deploy
    "parameters": {
        "target_list": [                                             # Deployment container information, if set to a fixed value, no need to specify
            {
                "workload_type": "Deployment",                       # Deployment container application type, supports Deployment and StatefulSet
                "workload_name": "service2",                         # Deployment container application name
                "container_name": "service2",                        # Deployment container application container name
                "image_name": "koderover.***.com/test/service2:0505" # Deployment container image information
            }
        ]
    }
}
```

**General Tasks**
```
{
    "job_name": "jira-issue-update",            # General task name
    "job_type": "freestyle",                    # General task type, specified as freestyle
    "parameters": {                             # Parameters and values in general tasks, if set to a fixed value or global variable, no need to specify
        "kv": [
            {
                "key": "IssueID",
                "value": "ZAD-10126"
            },
            {
                "key": "FromStatus",
                "value": "Testing"
            },
            {
                "key": "TargetStatus",
                "value": "ToBeReleased"
            }
        ],
        "repo_info": [                          # Code repository information in general tasks
            {
                "codehost_name": "koderover",   # Code source identifier
                "repo_namespace": "koderover",  # Code repository organization name/username
                "repo_name": "zadig",           # Code repository name
                "branch": "task-mgr"            # Code repository branch
            }
        ]
    }
}
```

**Test tasks**
```
{
    "job_name": "test-myapps",                            # Test task name
    "job_type": "zadig-test",                             # Build task type, specified as zadig-test
    "parameters": {
        "testing_list": [                                 # Test task information
            {
                "testing_name": "unit-test",              # Test task name
                "repo_info": [{                           # Test task code repository information
                    "codehost_name": "koderover",         # Code source identifier
                    "repo_namespace": "koderover",        # Code repository organization name/username
                    "repo_name": "zadig",                 # Code repository name
                    "branch": "main"                      # Code repository branch
                }]
                inputs: [{                                # Test variable information, if set to a fixed value or global variable, no need to specify
                    "key": "username",
                    "value": "admin"
                },
                {
                    "key": "password",
                    "value": "Zadig"
                }]
            },
            {
                "testing_name": "integration-test",
                "repo_info": [{
                    "codehost_name": "koderover",
                    "repo_namespace": "koderover",
                    "repo_name": "zadig-portal",
                    "branch": "main"
                }]
            }
        ]
    }
}
```

**Code scanning task**
```
{
    "job_name": "scan-myapps",                            # Code scanning task name
    "job_type": "zadig-scanning",                         # Build task type, specified as zadig-scanning
    "parameters": {
        "scanning_list": [                                # Code scanning task information
            {
                "scanning_name": "scan",                  # Code scanning task name
                "repo_info": [{                           # Code scanning task code repository information
                    "codehost_name": "koderover",         # Code source identifier
                    "repo_namespace": "koderover",        # Code repository organization name/username
                    "repo_name": "zadig",                 # Code repository name
                    "branch": "main"                      # Code repository branch
                }]
            },
            {
                "scanning_name": "scan-1",
                "repo_info": [{
                    "codehost_name": "koderover",
                    "repo_namespace": "koderover",
                    "repo_name": "zadig-portal",
                    "branch": "main"
                }]
            }
        ]
    }
}
```

**SQL Task**
```
{
    "job_name": "sql",                                  # SQL task name
    "job_type": "sql",                                  # SQL task type, specified as sql
    "parameters": {
        "database_name": "mysql",                       # Database name
        "sql": "show databases;"                        # SQL statement
    }
}
```

**Custom tasks**
```
{
    "job_name": "plugin-task",                           # Custom task name
    "job_type": "plugin",                                # Custom task type, specified as plugin
    "parameters": {                                      # Custom task variables
        "kv": [
            {
                "key": "CONTENT",
                "value": "hello world"
            }
        ]
    }
}
```

**Return normally**

```
{
    "project_name": "simple-service-demo", # Project identifier
    "workflow_name": "openapi-test",       # Workflow name
    "task_id": 20                          # Workflow task execution sequence ID
}
```


### Cancel Workflow Tasks

**Request**

```
DELETE /openapi/workflows/custom/task?taskId=<taskId>&workflowKey=<workflow identifier>
```

**Query**

| Parameter Name | Required | Description         | Default Value | Is it Required |
| -------------- | -------- | ------------------- | ------------- | -------------- |
| `taskId`       | int      | Workflow Task ID    | None          | Yes            |
| `workflowKey`  | string   | Workflow Identifier | None          | Yes            |

**Return normally**

```
{
    "message": "success"
}
```

**Exception return**

```
# The specified workflow task has been successfully run
{
    "code": 6163,
    "description": "task: build-images:20 is passed, cannot cancel",
    "extra": {},
    "message": "Cancel workflow task failed",
    "type": "error"
}

# The specified workflow or task does not exist
{
    "code": 6163,
    "description": "mongo: no documents in result",
    "extra": {},
    "message": "Cancel workflow task failed",
    "type": "error"
}
```

### Retry the Workflow Task

**Request**

```
POST /openapi/workflows/custom/:workflowKey/task/:taskID?projectKey=<project identifier>
```

**query Parameter description**

| Parameter Name | Required | Description        | Is it Required | Default Value |
| -------------- | -------- | ------------------ | -------------- | ------------- |
| `projectKey`   | string   | Project identifier | Yes            | None          |

**Path parameter description**

| Parameter Name | Required | Description         | Is it Required | Default Value |
| -------------- | -------- | ------------------- | -------------- | ------------- |
| `workflowKey`  | string   | Workflow Identifier | Yes            | None          |
| `taskID`       | int      | Workflow task ID    | Yes            | None          |

**Return normally**

```json
{
  "message": "success"
}
```

**Exception return**

```json
{
    "code": 6161,
    "description": "mongo: no documents in result",
    "extra": {},
    "message": "Get workflow task failed",
    "type": "error"
}
```

### Approval Workflow

::: tip
Applicable to Zadig approval.
:::

**Request**

```
POST /openapi/workflows/custom/task/approve
```

**body Parameter description**

| Parameter Name | Required | Description                                              | Default Value | Is it Required |
| -------------- | -------- | -------------------------------------------------------- | ------------- | -------------- |
| `task_id`      | int      | Workflow Task ID                                         | None          | Yes            |
| `workflow_key` | string   | Workflow Identifier                                      | None          | Yes            |
| `stage_name`   | string   | The name of the stage for which the workflow is approved | None          | Yes            |
| `approve`      | bool     | Whether the approval is approved                         | false         | No             |
| `comment`      | string   | Approval information                                     | None          | No             |

**body Parameter example**

``` json
{
    "task_id": 2,
    "workflow_key": "infra-dev-workflow",
    "stage_name": "deploy",
    "approve": true,
    "comment": "LGTM"
}
```

**Return normally**

```
{
    "message": "success"
}
```

**Exception return**

```
# The stage specified by the parameter does not need approval
{
    "code": 6169,
    "description": "workflow build-images ID 23 stage deploy-myapps do not need approve",
    "extra": {},
    "message": "Approve workflow task failed",
    "type": "error"
}

```

### Create a Workflow

**Request**

```
POST /api/aslan/workflow/v4
```

**body Parameter description**

::: tip
The parameters of this interface are relatively complex and it is more laborious to assemble it yourself. It is recommended to create a workflow in the page first -> Click `YAML` -> on the configuration page to copy YAML content and use [the online conversion tool](https://onlineyamltools.com/convert-yaml-to-json) to quickly obtain parameters.

<img src="../../../_images/custome-workflow-yaml-demo.png" width="400">
:::

| Parameter Name      | Required          | Description                                                                | Default Value | Is it Required |
| ------------------- | ----------------- | -------------------------------------------------------------------------- | ------------- | -------------- |
| `name`              | string            | Workflow Identifier                                                        | None          | Yes            |
| `display_name`      | string            | Workflow Name                                                              | None          | Yes            |
| `project`           | string            | Project identifier                                                         | None          | Yes            |
| `description`       | string            | Workflow description information                                           | None          | No             |
| `concurrency_limit` | int               | Workflow task concurrency number, -1 means unlimited, 0 means unexecutable | 0             | Yes            |
| `stages`            | [][Stage](#Stage) | Phase configuration                                                        | None          | No             |

<h4 id="!">Stage Parameter description</h4>

| Parameter Name | Description                            | Required      | Required |
| -------------- | -------------------------------------- | ------------- | -------- |
| `name`         | Stage name                             | string        | Yes      |
| `parallel`     | Whether to enable concurrent execution | bool          | Yes      |
| `jobs`         | Task Configuration                     | []interface{} | Yes      |

**body Parameter example**

The following body The example contains `Build` -> `Deploy` -> `Test` -> `Image Distribution` five stages:

::: details
``` json
{
    "name": "workflow-demo",
    "display_name": "workflow-demo",
    "project": "demo",
    "description": "workflow-demo description",
    "concurrency_limit": 5,
    "stages": [
        {
            "name": "Build",
            "parallel": true,
            "jobs": [
                {
                    "name": "build",
                    "type": "zadig-build",
                    "run_policy": "",
                    "spec": {
                        "docker_registry_id": "62c**********",
                        "service_and_builds": [
                            {
                                "service_name": "service1",
                                "service_module": "service1",
                                "image_name": "nginx",
                                "value": "service1/service1",
                                "build_name": "build-demo"
                            }
                        ]
                    }
                }
            ]
        },
        {
            "name": "Deploy",
            "parallel": true,
            "approval": {
                "enabled": true,
                "type": "native",
                "native_approval": {
                    "approve_users": [
                        {
                            "user_name": "admin",
                            "user_id": "9792310b-**********"
                        },
                        {
                            "user_name": "sre-admin",
                            "user_id": "9837370s-**********"
                        }
                    ],
                    "timeout": 5,
                    "needed_approvers": 1
                }
            },
            "jobs": [
                {
                    "name": "deploy",
                    "type": "zadig-deploy",
                    "spec": {
                        "env": "dev",
                        "production": false,
                        "deploy_contents": [
                            "image"
                        ],
                        "skip_check_run_status": false,
                        "source": "fromjob",
                        "job_name": "build",
                        "service_and_images": [
                            {
                                "service_name": "service1",
                                "service_module": "service1",
                                "value": "service1/service1"
                            }
                        ]
                    }
                }
            ]
        },
        {
            "name": "Test",
            "parallel": true,
            "jobs": [
                {
                    "name": "test",
                    "type": "zadig-test",
                    "spec": {
                        "test_type": "service_test",
                        "source": "fromjob",
                        "job_name": "build",
                        "service_and_tests": [
                            {
                                "service_name": "service1",
                                "service_module": "service1",
                                "name": "smoke-test",
                                "project_name": "voting-app"
                            }
                        ]
                    }
                }
            ]
        },
        {
            "name": "Distribute",
            "parallel": true,
            "jobs": [
                {
                    "name": "common",
                    "type": "freestyle",
                    "run_policy": "",
                    "spec": {
                        "properties": {
                            "timeout": 60,
                            "res_req": "low",
                            "res_req_spec": {
                                "cpu_limit": 1000,
                                "memory_limit": 512
                            },
                            "cluster_id": "",
                            "build_os": "focal",
                            "image_id": "630xxxxxxxxxxxx",
                            "image_from": "koderover",
                            "envs": [
                                {
                                    "key": "key1",
                                    "value": "val1",
                                    "type": "string",
                                    "is_credential": false
                                }
                            ],
                            "cache_enable": true,
                            "cache_dir_type": "workspace",
                            "cache_user_dir": ""
                        },
                        "steps": [
                            {
                                "name": "tools",
                                "type": "tools",
                                "spec": {
                                    "installs": [
                                        {
                                            "name": "go",
                                            "version": "1.19.3",
                                            "id": "go1.19.3"
                                        }
                                    ]
                                }
                            },
                            {
                                "name": "git",
                                "type": "git",
                                "spec": {
                                    "repos": [
                                        {
                                            "codehost_id": 23,
                                            "repo_owner": "owner1",
                                            "repo_name": "hello",
                                            "source": "GitHub",
                                            "branch": "main",
                                            "checkout_path": "",
                                            "remote_name": "origin",
                                            "submodules": false,
                                            "hidden": false,
                                            "repo_namespace": "owner1"
                                        }
                                    ]
                                }
                            },
                            {
                                "name": "shell",
                                "type": "shell",
                                "spec": {
                                    "script": "#!/bin/bash\nset -e\necho hello"
                                }
                            }
                        ]
                    }
                }
            ]
        },
        {
            "name": "Image Distribution",
            "parallel": true,
            "jobs": [
                {
                    "name": "image-release",
                    "type": "zadig-distribute-image",
                    "run_policy": "",
                    "isCreate": true,
                    "spec": {
                        "source": "fromjob",
                        "job_name": "build",
                        "source_registry_id": "",
                        "target_registry_id": "630xxxxxxxxxxxx",
                        "targets": [
                        {
                            "service_name": "n-1",
                            "service_module": "nginx-latest",
                            "image_name": "nginx",
                            "value": "n-1/nginx-latest"
                        }
                        ],
                        "timeout": 10,
                        "cluster_id": "",
                        "params": []
                    }
                }
            ]
        }
    ]
}
```
:::

### Update Workflow

**Request**

```
PUT /api/aslan/workflow/v4/:name?projectName=<project_name>
```

**query Parameter description**

| Parameter Name | Required | Description        | Is it Required | Default Value |
| -------------- | -------- | ------------------ | -------------- | ------------- |
| `projectName`  | string   | Project identifier | Yes            | None          |

**Path parameter description**

| Parameter Name | Required | Description   | Is it Required | Default Value |
| -------------- | -------- | ------------- | -------------- | ------------- |
| `name`         | string   | Workflow Name | Yes            | None          |

**body Parameter description**

Reference [Create Workflow Parameters](#create-a-workflow)

### Delete Workflow

**Request**

```
DELETE /openapi/workflows/custom?workflowKey=<workflow identifier>&projectKey=<project identifier>
```

**query Parameter description**

| Parameter Name | Required | Description         | Default Value | Is it Required |
| -------------- | -------- | ------------------- | ------------- | -------------- |
| `workflowKey`  | string   | Workflow Identifier | None          | Yes            |
| `projectKey`   | string   | Project identifier  | None          | Yes            |

**Return normally**

```json
{
  "message": "success"
}
```

## Workflow View

### Get a Workflow View List

**Request**

```
GET /openapi/workflows/view?projectKey=<project identifier>
```

**query Parameter description**

| Parameter Name | Required | Description        | Is it Required | Default Value |
| -------------- | -------- | ------------------ | -------------- | ------------- |
| `projectKey`   | string   | Project identifier | Yes            | None          |

**Return Description**

| Parameter Name | Description        | Required                  |
| -------------- | ------------------ | ------------------------- |
| `name`         | View name          | string                    |
| `project_key`  | Project identifier | string                    |
| `update_time`  | Update Time        | int                       |
| `update_by`    | Updater            | string                    |
| `workflows`    | Workflow list      | [][workflow](#workflow-3) |

<h4 id="workflow-3">workflow </h4>

| Parameter Name  | Description         | Required |
| --------------- | ------------------- | -------- |
| `workflow_key`  | Workflow Identifier | string   |
| `workflow_type` | `custom`            | string   |

**Return normally**

::: details
```json
[
    {
        "name": "test-view",
        "project_key": "lilian-test",
        "workflows": [
            {
                "workflow_key": "xiaxianfuwu",
                "workflow_type": "custom",
            }
        ],
        "update_time": 1689329334,
        "update_by": "admin"
    }
]
```
:::

### Create a Workflow View

**Request**

```
POST /openapi/workflows/view
```

**body Parameter description**

| Parameter Name  | Description        | Required                  | Required |
| --------------- | ------------------ | ------------------------- | -------- |
| `project_key`   | Project identifier | string                    | Yes      |
| `name`          | Workflow view name | string                    | Yes      |
| `workflow_list` | Workflow list      | [][Workflow](#workflow-1) | Yes      |

<h4 id="workflow-1">Workflow Parameter description</h4>

| Parameter Name  | Description         | Required | Required |
| --------------- | ------------------- | -------- | -------- |
| `workflow_key`  | Workflow Identifier | string   | Yes      |
| `workflow_type` | `custom`            | string   | Yes      |

**body Parameter example**

::: details
``` json
{
    "project_key": "demo",
    "name": "view-demo",
    "workflow_list": [
        {
            "workflow_key": "dev",
            "workflow_type": "custom"
        },
        {
            "workflow_key": "nacos-config-update",
            "workflow_type": "custom"
        }
    ]
}
```
:::

**Return normally**

```json
{
  "message": "success"
}
```

### Edit Workflow View

**Request**

```
PUT /openapi/workflows/view/:viewName?projectKey=<project identifier>
```

**query Parameter description**

| Parameter Name | Required | Description        | Is it Required | Default Value |
| -------------- | -------- | ------------------ | -------------- | ------------- |
| `projectKey`   | string   | Project identifier | Yes            | None          |

**Path parameter description**

| Parameter Name | Required | Description | Is it Required | Default Value |
| -------------- | -------- | ----------- | -------------- | ------------- |
| `viewName`     | string   | View name   | Yes            | None          |

**body Parameter description**

| Parameter Name  | Description   | Required                  | Required | Default Value |
| --------------- | ------------- | ------------------------- | -------- | ------------- |
| `workflow_list` | Workflow list | [][Workflow](#workflow-2) | Yes      | None          |

<h4 id="workflow-2">workflow </h4>

| Parameter Name  | Description                                                                   | Required | Required | Default Value |
| --------------- | ----------------------------------------------------------------------------- | -------- | -------- | ------------- |
| `workflow_key`  | Workflow Identifier                                                           | string   | Yes      | None          |
| `workflow_type` | `custom`                                                                      | string   | Yes      | None          |
| `enabled`       | `true` : Add workflow to view<br> `false` : Remove the workflow from the view | bool     | Yes      | None          |

**body Parameter example**

::: details

```json
{
    "workflow_list":[
        {
            "workflow_key":"build-deploy",
            "workflow_type":"custom",
            "enabled":true
        }
    ]
}
```

:::

**Return normally**

```json
{
  "message": "success"
}
```

### Delete the Workflow View

**Request**

```
DELETE /openapi/workflows/view/:viewName?projectKey=<project identifier>
```

**query Parameter description**

| Parameter Name | Required | Description        | Is it Required | Default Value |
| -------------- | -------- | ------------------ | -------------- | ------------- |
| `projectKey`   | string   | Project identifier | Yes            | None          |

**Path parameter description**

| Parameter Name | Required | Description | Is it Required | Default Value |
| -------------- | -------- | ----------- | -------------- | ------------- |
| `viewName`     | string   | View name   | Yes            | None          |

**Return normally**

```json
{
    "message": "success"
}
```

**Exception return**

```json
{
    "code": 6894,
    "description": "find workflow view error: mongo: no documents in result",
    "extra": {},
    "message": "delete workflow view error: mongo: no documents in result",
    "type": "error"
}
```

## Workflow Pre-Approval

### Create a Pre-Approval Form

**Request**

```
POST /openapi/ticket/approval
```

**Body Parameter description**

| Parameter Name           | Required                      | Description                                                                        | Is it Required | Default Value |
| ------------------------ | ----------------------------- | ---------------------------------------------------------------------------------- | -------------- | ------------- |
| `project_key`            | string                        | Project identifier                                                                 | Yes            | None          |
| `approval_id`            | string                        | Third-party system approval form number                                            | Yes            | None          |
| `status`                 | int                           | Approval form status:<br> 0- The approval form is invalid<br> 1- form takes effect | Yes            | None          |
| `envs`                   | string                        | Optional environment restrictions, empty is unlimited                              | No             | None          |
| `services`               | [][ServiceInfo](#serviceinfo) | Optional service restrictions, empty is unlimited                                  | No             | None          |
| `users`                  | [][User](#user)               | User restrictions can be executed, empty is unlimited                              | No             | None          |
| `execution_window_start` | int                           | The executable time window start time, empty is unlimited                          | No             | None          |
| `execution_window_end`   | int                           | Executable time window end time, empty is unlimited                                | No             | None          |


<h4 id="serviceinfo">ServiceInfo Structure</h4>

| Parameter Name | Required | Description        | Is it Required | Default Value |
| -------------- | -------- | ------------------ | -------------- | ------------- |
| service_name   | string   | Service name       | Yes            | None          |
| service_module | string   | Service Components | Yes            | None          |


<h4 id="user">User Structure</h4>

| Parameter Name | Required | Description                                                     | Is it Required | Default Value |
| -------------- | -------- | --------------------------------------------------------------- | -------------- | ------------- |
| name           | string   | User name, used for the approval form display                   | Yes            | None          |
| email          | string   | Email address, used to connect to user systems in Zadig systems | Yes            | None          |


**Return normally**

```json
{
  "code": 1,
  "message": "success"
}
```

**Error return**

```json
{
  "code": 500,
  "description": "...",
  "message": "Internal Error"
}
```


## Workflow Logs

### View Real-time Workflow Task Logs

When workflow tasks are executing, real-time logs can be viewed through this API.

**Request**

```
GET /openapi/logs/sse/v4/workflow/<workflow_id>/<workflow_task_id>/<workflow_job_task_id>/<tail_lines>
```

**Response Example**

::: details
This API returns SSE stream data in the following format:

```
"log message line 1"
"log message line 2"
...
```
:::

### View Complete Workflow Task Logs

After workflow tasks complete execution, complete logs can be viewed through this API.

**Request**

```
GET /openapi/logs/log/v4/workflow/<workflow_id>/<workflow_task_id>/<workflow_job_task_id>
```

**Response Example**

::: details
```
"log message line 1"
"log message line 2"
...
```
:::